<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>HuBMAP Kidney Blood Vessel Segmentation Challenge on Kaggle | Kevin (Won June) Cho</title> <meta name="author" content="Kevin (Won June) Cho"> <meta name="description" content="Participation in Kaggle Competition to Sharpen Image Segmentation Technique"> <meta name="keywords" content="deep-learning, image-segmentation, python, pytorch"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://chokevin8.github.io/projects/6_project/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Kevin (Won June) Cho</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About Me</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">My Blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">My Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">My Github</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">My Resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">HuBMAP Kidney Blood Vessel Segmentation Challenge on Kaggle</h1> <p class="post-description">Participation in Kaggle Competition to Sharpen Image Segmentation Technique</p> <p class="post-moredescription"><i> Personal Side Project (2023) </i></p> </header> <article> <hr> <h3 id="project-motivation--background"><strong><em>Project Motivation &amp; Background:</em></strong></h3> <p>Since this is a <a href="https://www.kaggle.com/competitions/hubmap-hacking-the-human-vasculature/overview" rel="external nofollow noopener" target="_blank">Kaggle competition (link)</a>, below is the copy-and-pasted “motivation” or context of designing the competition for <em>annotating blood vessels, or microvasculature from healthy human H&amp;E kidney slides</em>:</p> <blockquote> "The proper functioning of your body's organs and tissues depends on the interaction, spatial organization, and specialization of your cells—all 37 trillion of them. With so many cells, determining their functions and relationships is a monumental undertaking. Current efforts to map cells involve the Vasculature Common Coordinate Framework (VCCF), which uses the blood vasculature in the human body as the primary navigation system. The VCCF crosses all scale levels--from the whole body to the single cell level--and provides a unique way to identify cellular locations using capillary structures as an address. However, the gaps in what researchers know about microvasculature lead to gaps in the VCCF. If we could automatically segment microvasculature arrangements, researchers could use the real-world tissue data to begin to fill in those gaps and map out the vasculature. Competition host Human BioMolecular Atlas Program (HuBMAP) hopes to develop an open and global platform to map healthy cells in the human body. Using the latest molecular and cellular biology technologies, HuBMAP researchers are studying the connections that cells have with each other throughout the body. There are still many unknowns regarding microvasculature, but your Machine Learning insights could enable researchers to use the available tissue data to augment their understanding of how these small vessels are arranged throughout the body. Ultimately, you'll be helping to pave the way towards building a Vascular Common Coordinate Framework (VCCF) and a Human Reference Atlas (HRA), which will identify how the relationships between cells can affect our health." </blockquote> <p>If interested, the raw data and the information about the data can also be found <a href="https://www.kaggle.com/competitions/hubmap-hacking-the-human-vasculature/data" rel="external nofollow noopener" target="_blank">here</a>. Writing all about the background of this competition regarding motivation, data, evaluation metric, etc. would be too repetitive since it’s all in the website, so I’ll skip this part and focus on the methods.</p> <hr> <h3 id="methods"><strong><em>Methods:</em></strong></h3> <p>The main steps that I took to tackle this problem is: <br></p> <ul> <li> <strong>Preprocessing the raw data</strong> <ul> <li>Preprocessing .json annotation files and data/metadata in .csvs. Dividing different versions of datasets depending on which approach of training to take (ex. training a single object detection model for blood vessel, or train a segmentation model with two classes (blood vessel and glomerulus))</li> <li>Performing exploratory data analysis (EDA) to really dive into the metadata (ex. how many WSI images there are, how many tiles in each WSI, tile size, etc.)</li> <li>Then, using the .json annotation files to create binary masks (image) or a .txt file with (x,y) coordinate contours. This is paramount so that it can be utilized as labels for supervised training later.</li> <li>After training image and label is properly paired, using either each WSI number or class label as a stratification method to create cross-validation folds of the tiled images. Due to class imbalance of training data, it can usually be a good idea to stratify based on class and create a 5-fold cross validation pipeline.</li> </ul> </li> <li> <strong>Training and validating different models</strong> <ol> <li> <em>Image augmentation/normalization:</em> <ul> <li>Experimenting with different degrees and techniques of augmentation is crucial, and also the same with image normalization. Some common image augmentations such as horizontal/vertical flips, resizes, color jittering, noising/blurring, etc are explored.</li> <li> <a href="https://arxiv.org/abs/2206.12694" rel="external nofollow noopener" target="_blank">RandStainNA</a>, which is a pipeline that does image augmentation and normalization at the same time by utilizing other color spaces such as LAB and HSV is also explored.</li> </ul> </li> <li> <em>Choosing a model architecture to train:</em> <ul> <li>UNet (semantic segmentation), YOLOv8 (object detection/instance segmentation), and Mask2Former (semantic segmentation) models are chosen. These models are quite different from each other, so it was nice to explore each of them.</li> <li>Then, if a pretrained model is available, explore if pretrained models will be useful (domain-specific or non-domain-specific). A pretrained domain-specific (histopathology) model hub developed <a href="https://github.com/lunit-io/benchmark-ssl-pathology" rel="external nofollow noopener" target="_blank">here</a> is tested on model architectures if compatible.</li> </ul> </li> <li> <em>Choosing a loss function and validation metric:</em> <ul> <li>Depending on the model, different loss functions and combinations of them are tested.</li> <li>For example, UNet can be trained with different loss functions like Dice/Jaccard(IOU)/BCE losses, while YOLOv8 will be a combination of Focal, Bbox, and IOU loss.</li> <li>Because the evaluation metric is known (average precision (AP) @0.6 IOU), returning the metric during validation is important.</li> </ul> </li> </ol> </li> <li> <strong>Running inference locally and tuning (if possible)</strong> <ul> <li>Testing and validation metric are tested to see if they are closely correlated to see if training process is accurate and robust (no under/over-fitting).</li> <li>Once a decent model is trained, if possible, hyperparameters are tuned to further enhance the model performance.</li> <li>Test time augmentation (TTA) is also utilized to see if it can improve inference results.</li> </ul> </li> </ul> <p><em>Note that detailed methods can be seen in the preprocessing/training/infer/tune <a href="https://github.com/chokevin8/Kaggle-hubmap" rel="external nofollow noopener" target="_blank">code on github</a>.</em></p> <hr> <h3 id="results"><strong><em>Results:</em></strong></h3> <p>While the goal of this project wasn’t focused on winning the competition (lack of time and experience/skills for me to do that yet), but there were still a list of things that I tried doing that worked and didn’t work in increasing the performance of the model.</p> <ul> <li> <em>Things that worked:</em> <ul> <li>Dilating the dataset 2 annotations, since the annotations are inconsistent (some including the endothelial cells around blood vessels and some not) to make the annotations consistent with one another.</li> <li>Stratification of WSI tiles based on dataset number and making sure each CV fold has dataset 1 for training and validation since testing dataset is solely based on dataset 1.</li> <li>Using Albumentation’s normalization and augmentation pipeline boosted performance compared to Torchvision or RandstainNA.</li> <li>YOLOv8 instance segmentation model worked pretty well, with some edits to the loss function weightings.</li> <li>Utilizing Test-time augmentation (TTA) on YOLOv8 and UNet boosted performance compared to not utilizing it.</li> </ul> </li> <li> <em>Things that didn’t seem to work:</em> <ul> <li>Stratification of WSI tiles based on its classes didn’t work. Probably because the testing dataset was solely on dataset 1, so the validation data needs to include majority of dataset 1.</li> <li>Using RandStainNA as an augmentation + normalization tool together did not boost performance.</li> <li>Surprisingly, using pretrained model on histopathology dataset (Resnet50 backbone) didn’t boost performance at all compared to random initialization.</li> <li>Using UNet as a sole semantic segmentation model, probably because the competition metric is an object-detection based metric, and UNet doesn’t naturally create Bboxes and a confidence value.</li> <li>Using Mask2Former as a sole semantic segmentation model, but probably because I may have used the wrong pretrained model (imagenet pretrained).</li> <li>Self-supervised learning, this is something I couldn’t do due to only having access to a single GPU.</li> </ul> </li> </ul> <hr> <h3 id="personal-comments"><strong><em>Personal Comments:</em></strong></h3> <h3 id="q-why-did-i-choose-this-project">Q: Why did I choose this project?</h3> <p>I decided to work on this project on the side whenever I had time to work on it, since I thought that I would need more experience in working on an entire project pipeline by myself. I thought that performing the entire DL research pipeline of EDA -&gt; Data Preprocessing -&gt; Training/Validating -&gt; Testing/Tuning -&gt; Post-processing by myself would be massively helpful to learn more about the technical skills (Python, PyTorch, etc) required for a DL researcher/scientist.</p> <h3 id="q-what-did-i-do-outside-of-this-project">Q: What did I do outside of this project?</h3> <p>More background research (reading literature/online documentations) on:</p> <ul> <li>Techniques for H&amp;E image normalization and augmentation (ex. Reinhard, Vahadane, StainTools, RandStainNA, Albumentations, Torchvisions, etc.)</li> <li>List of self-supervised learning techniques (ex. Barlow Twins, MoCoV2, etc.)</li> <li>Different model architectures (ex. UNet, Mask R-CNN, DeepLabv3+, YOLO, etc.) for segmentation.</li> <li>Different loss functions and their differences (ex. Dice, Jaccard (IOU), Focal, BCE, Tversky, Bbox, etc.)</li> <li>Tuning techniques (learning how to use Ray Train and Tune)</li> </ul> <h3 id="q-what-impact-did-this-project-have-on-me">Q: What impact did this project have on me?</h3> <p>In academic research as a master’s student, you often work together on a project as a group or work independently but only for a part of a pipeline. As this was my first time going through a full DL research pipeline by myself, I discovered that so much time and effort could be saved if you actually <em>planned out your experiments</em>. This may sound cliché, but I think new DL researchers like me suffer with this a lot.</p> <p>For example, in retrospect, for some of my training runs I had no idea why I was performing them, as I treated the DL model as a complete “black box” (while this is partially true, it’s not 100% a black box) even when I already set the random seeds for all modules for full reproducibility. Some other mistakes I made was training a huge model with the entire dataset before performing a smaller-scale experiment as a proof of concept. This led me to waste a lot of unnecessary time and efforts that could’ve been used elsewhere. Starting from a smaller-scale model and data with small number of epochs as a proof-of-concept is crucial, as often times switching to a bigger model and more dataset is more about tuning the hyperparameters (which can be done after successful training) like batch size, learning rate, number of epochs, etc.</p> <hr> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Kevin (Won June) Cho. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>