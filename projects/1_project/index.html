<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Virtual Stain Conversion of IHC/Unstained to H&amp;E Images (IHC2HE/US2HE) | Kevin (Won June) Cho</title> <meta name="author" content="Kevin (Won June) Cho"> <meta name="description" content="Design of Generative Models to Virtually Stain/Convert IHC/Unstained (Bright-field) Images to H&amp;E Images"> <meta name="keywords" content="deep-learning, image-segmentation, python, pytorch"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://chokevin8.github.io/projects/1_project/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Kevin (Won June) Cho</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About Me</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">My Blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">My Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">My Github</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">My Resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Virtual Stain Conversion of IHC/Unstained to H&amp;E Images (IHC2HE/US2HE)</h1> <p class="post-description">Design of Generative Models to Virtually Stain/Convert IHC/Unstained (Bright-field) Images to H&amp;E Images</p> <p class="post-moredescription"><i>Master's Thesis Project (2023 ~ Present)</i></p> </header> <article> <hr> <h3 id="project-motivation--background"><strong>Project Motivation &amp; Background:</strong></h3> <p><br></p> <p><strong>Let’s play a simple guessing game:</strong> Look at the two pictures below. At the most left is the ground truth IHC image to be converted. The next two images on the right are the ground truth H&amp;E version of the ground truth IHC image and the virtually stained H&amp;E version of the ground truth IHC image. Can you guess which is “real” and which is “fake”?</p> <div class="row"> <div class="col-sm"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/1_project/ihc2_he_intro-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/1_project/ihc2_he_intro-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/1_project/ihc2_he_intro-1400.webp"></source> <img src="/assets/img/1_project/ihc2_he_intro.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="IHC2HE_intro" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>The correct answer is that the images in the right (column) are the “fake” ones, or the ones sampled from the generative model. <br> <br> Let’s play another game, this time for a ground truth unstained, bright-field image to be converted. The next two images on the right are the ground truth H&amp;E version of the ground truth unstained image and the virtually stained H&amp;E version of the ground truth unstained image. Can you guess which is “real” and which is “fake”?</p> <div class="row"> <div class="col-sm"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/1_project/us2_he_intro-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/1_project/us2_he_intro-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/1_project/us2_he_intro-1400.webp"></source> <img src="/assets/img/1_project/us2_he_intro.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="US2HE_intro" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>The correct answer again is that the images in the right (column) are the “fake” ones, or the ones sampled from the generative model. If you look closely, you could tell that the images on the right have slight artifacts and may be a bit “awkward” in general, this is because this is still a work in progress. With correct training, I hope to make them indistinguishable! The above two examples tell us the two different kinds of stain conversions that exist: 1) label-free-to-stain conversions and 2) stain-to-stain conversions. But someone may ask, <strong>why do we want to do this? Why virtually stain or convert stains?</strong></p> <p>First of all, commonly used histopathological stains such as H&amp;E (Hematoxylin &amp; Eosin), IHC (Immunohistochemistry), IF (Immunofluorescence), and others are all used to examine different types of body tissues for various research of diseases (pathology). For example, H&amp;E and specific types of IHC stains are commonly used in cancer pathology research, as each stain visualizes the tissue and cellular structures of the tissue in its own way, and therefore allow new digital biomarkers to be developed by utilizing the stained images. However, histopathological stains are also commonly used for disease diagnostics, as for example, IHC staining for the specific tumor/cancer biomarker of HER2 can reveal different treatment plans for HER2 positive or negative patients.</p> <p>While histopathological stains are widely used in disease research and diagnostics, the procedures of staining carried out in pathology labs are often time-consuming, expensive, and also can be extremely tricky to perform. The procedure is time-consuming due to the complexity of the staining process- tissue extraction, fixation, embedding, mounting, and staining are mostly all laborious tasks. Furthermore, specific types of stains, like IHC stains, can be very expensive, especially if they are used for disease research instead of disease diagnostics as obtaining large amounts of IHC-stained tissue slides can easily cost a fortune. Furthermore, the staining process itself also causes mechanical and chemical damages to the tissues, and if poorly performed, can damage the tissue. Most importantly, applying a stain on a tissue slide prevents other types of staining on the same slide, preventing further biological analysis on the same slide.</p> <p>While virtual staining cannot expedite the time-consuming process of tissue extraction, fixation, embedding, and mounting, it can resolve most of the other issues mentioned above. Virtual stain conversions from label-free (unstained) slides to stained slides can not only expedite the staining process, it can be more accurate due to absence of mechanical/chemical damage on the tissue and be much cheaper as the stain does not need to be purchased. Furthermore, stain-to-stain conversions have a huge benefit as it allows staining on the same tissue slide, enabling further biological analysis on the same slide. <strong>Therefore, the main motivation of the unstained-to-HE virtual stain conversion of skin tissue images is to expedite and refine the staining process, while the main motivation of the IHC-to-HE virtual stain conversion of pancreatic tissue images is to allow multiple stain analysis on the same tissue slide.</strong></p> <hr> <h3 id="methods"><strong>Methods:</strong></h3> <p>Below is the scheme for training and evaluating the trained model for the IHC-to-HE virtual stain conversion project. The same pipeline is applied to the unstained-to-HE virtual stain conversion project as well.</p> <div class="row"> <div class="col-sm"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/1_project/IHC2HE_training-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/1_project/IHC2HE_training-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/1_project/IHC2HE_training-1400.webp"></source> <img src="/assets/img/1_project/IHC2HE_training.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="IHC2HE_training" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row"> <div class="col-sm"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/1_project/IHC2HE_evaluation-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/1_project/IHC2HE_evaluation-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/1_project/IHC2HE_evaluation-1400.webp"></source> <img src="/assets/img/1_project/IHC2HE_evaluation.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="IHC2HE_eval" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>As seen above, I registered the serial sections together so that the IHC-H&amp;E image pair are aligned properly. Then, they are tiled to 256 x 256 tiles and divided into train/val/test sets. The main thing to note here is that I am training a vanilla pix2pix (GAN) model and a more novel score-based-generative model called image-to-image schrödinger bridge (<a href="https://arxiv.org/pdf/2302.05872.pdf" rel="external nofollow noopener" target="_blank">I2SB</a>). The two generative models are trained. Then, as seen in the evaluation stage, the sampled image from the validation set is passed through a pretrained segmentation model to generate a tissue map. Next, this is compared to the ground truth tissue map generated from the ground truth image, and the F-1 score is deduced. I also plan to compare the quality of the images by calculating the inception score (IS) or/and Fréchet Inception Distance (FID) of the generated images.</p> <p>To briefly talk about the models, pix2pix is a familiar model for most. Like any other GAN models, through adversarial training with GAN and L1 loss, we map the pixels of image of one domain to another. However, I2SB is more novel- it is a new class of conditional diffusion model based on training a schrödinger bridge between two different domains A and B, which finds the optimal transport path of diffusing from domain A to domain B. I2SB is related to score-based generative models, and I plan to fully explain about this in a future blog post since it is very mathematically dense. The main reason of utilizing I2SB in this project is that all of the previous works of stain-to-stain conversion out there utilize different subtypes of GANs (pix2pix, cycleGAN, etc), and do not test on the state-of-the-art diffusion models and its variants like I2SB (obviously there are more theoretical reasons to not utilizing GANs since diffusion models are known to generate more diverse images and avoids adversarial training and mode collapse). But why not use diffusion, why use I2SB? Well, look at the below diagram:</p> <div class="row"> <div class="col-sm"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/1_project/I2SB_vs_diffusion-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/1_project/I2SB_vs_diffusion-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/1_project/I2SB_vs_diffusion-1400.webp"></source> <img src="/assets/img/1_project/I2SB_vs_diffusion.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="IHC2HE_eval" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>As seen above, the main difference between conditional latent/stable diffusion models and I2SB in the field of image to image translation or restoration is that the I2SB allows direct utilization of the degraded image or the image to be converted during training, which is a much more structurally informative prior compared to conditional diffusion models which start from noise during training/sampling and feeds the degraded image/image to be converted via conditioning. Likewise, in image restoration or translation, the degraded image or the image to be translated often contains useful structural information. <strong><em>This is definitely the case in our project, as for stain conversions, most or all of the structure should remain unchanged during the conversion.</em></strong> Furthermore, it also makes more intuitive sense that, to go from image A to B, it would make sense to directly train to go from A to B, not noise to B. With the models and the training/evaluation methods in mind, let’s look at the preliminary results.</p> <hr> <h3 id="results"><strong>Results:</strong></h3> <p><strong><em>Since this is currently a work-in-progress, updates will be made whenever possible.</em></strong></p> <p>Below are some of the pix2pix-generated H&amp;E images compared to the ground truth H&amp;E images:</p> <div class="row"> <div class="col-sm"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/1_project/pix2pix_result-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/1_project/pix2pix_result-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/1_project/pix2pix_result-1400.webp"></source> <img src="/assets/img/1_project/pix2pix_result.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="IHC2HE_eval" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>As expected for most GAN-based models, the circled region above shows low fidelity for some features of the image, image artifacts, and edge effects. Below is an example of direct comparison of pix2pix-generated and I2SB-generated image:</p> <div class="row"> <div class="col-sm"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/1_project/comparison_result-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/1_project/comparison_result-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/1_project/comparison_result-1400.webp"></source> <img src="/assets/img/1_project/comparison_result.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="IHC2HE_eval" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>As seen in the circled part of the image and the overall image, we can see that I2SB does a better job than pix2pix in generating a more realistic image compared to ground truth. Below are some of the DDPM sampled images from the trained I2SB model:</p> <div class="row"> <div class="col-sm"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/1_project/I2SB_result-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/1_project/I2SB_result-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/1_project/I2SB_result-1400.webp"></source> <img src="/assets/img/1_project/I2SB_result.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="IHC2HE_eval" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>As seen in the first image, we can see that the IHC stains get properly converted to H&amp;E as well. The second image shows local features being preserved during the stain conversion as well. With this DDPM sampling process, unlike GANs, we can also generate an interpolated image between two domains, if necessary for other uses.</p> <p>The F-1 score and FID to evaluate the performance of the two models are a work-in-progress since DDPM sampling is quite slow. For the unstained-to-H&amp;E virtual staining project, the model is still being trained, the image in the project motivation was just some image sampled from an intermediate checkpoint. As stated above, more updates will be posted here in the near future.</p> <p><strong><em>Note that more technical details/explanations and further results are omitted on purpose as I focus on motivation/personal comments in introducing the project. More technical details will be shown in the technical powerpoint presentation (PPT).</em></strong></p> <hr> <h3 id="personal-comments"><strong>Personal Comments:</strong></h3> <h3 id="q-why-did-i-choose-this-project">Q: Why did I choose this project?</h3> <p>After somewhat finishing training the segmentation model for the <a href="(/projects/2_project/)">H&amp;E image segmentation project</a>, I wanted to independently work on a challenging project. As mentioned in the motivation above, “fortunately”, I found that our lab would benefit from a virtual stain conversion method so that multiple stains can be analyzed in the same tissue slide. Furthermore, I was excited to dive into the realm of generative models as it was very different from image classification/segmentation models that I was working on previously.</p> <h3 id="q-what-did-i-do-outside-of-this-project">Q: What did I do outside of this project?</h3> <p>Similar to the H&amp;E image segmentation project, I also had no significant prior knowledge in the field of generative models, especially on GANs and diffusion models. To utilize I2SB and understand it properly, I had to do (and still doing) a lot of intensive background research on papers for GANs, diffusion models, score-based generative models (SGM), and schrödinger bridges (SB). I’d probably say that I’ve done a lot of math learning/recap regarding statistics and differential equations during this process.</p> <h3 id="q-what-impact-did-this-project-have-on-me">Q: What impact did this project have on me?</h3> <p>This project has fueled me to explore more types of deep learning fields. The field of computer vision and deep learning has still much more to offer than image classification,segmentation and generation.</p> <hr> <p><em>Image credits to:</em></p> <ul> <li><a href="https://arxiv.org/pdf/2302.05872.pdf" rel="external nofollow noopener" target="_blank">I2SB vs Diffusion Diagram</a></li> </ul> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Kevin (Won June) Cho. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>